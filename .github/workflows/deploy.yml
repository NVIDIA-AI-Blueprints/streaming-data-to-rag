name: Deploy Streaming Data to RAG

on:
  push:
    branches: [ main, develop]
  pull_request:
    branches: [ main]
  workflow_dispatch:

env:
  MODEL_DIRECTORY: ~/.cache/nim
  REPLAY_FILES: "sample_files/ai_gtc_1.mp3,sample_files/ai_gtc_2.mp3,sample_files/ai_gtc_3.mp3"
  REPLAY_TIME: 3600
  REPLAY_MAX_FILE_SIZE: 50
  RAG_UUID: "123456"

jobs:
  preflight:
    runs-on: ubuntu-latest
    outputs:
      nvidia-api-key-valid: ${{ steps.validate-nvidia-key.outputs.valid }}
      nvcf-config-token-exists: ${{ steps.check-secrets.outputs.nvcf_config_token_exists }}
    steps:
      - name: Check required secrets exist
        id: check-secrets
        run: |
          echo "Checking required secrets..."
          HAS_ERROR=false
          
          # Check NVIDIA_API_KEY exists
          if [ -z "${{ secrets.NVIDIA_API_KEY }}" ]; then
            echo "::error::NVIDIA_API_KEY secret is not configured!"
            echo "Please add your NVIDIA API key as a repository secret:"
            echo "  1. Go to Settings > Secrets and variables > Actions"
            echo "  2. Click 'New repository secret'"
            echo "  3. Name: NVIDIA_API_KEY"
            echo "  4. Value: your-nvidia-api-key-from-build.nvidia.com"
            HAS_ERROR=true
          else
            echo "NVIDIA_API_KEY secret exists"
          fi
          
          # Check NVCF_CONFIG_ON_GITHUB_TOKEN
          if [ -z "${{ secrets.NVCF_CONFIG_ON_GITHUB_TOKEN }}" ]; then
            echo "::warning::NVCF_CONFIG_ON_GITHUB_TOKEN secret is not configured. Hosted NIM endpoint scanning will be skipped."
            echo "nvcf_config_token_exists=false" >> $GITHUB_OUTPUT
          else
            echo "NVCF_CONFIG_ON_GITHUB_TOKEN secret exists"
            echo "nvcf_config_token_exists=true" >> $GITHUB_OUTPUT
          fi
          
          if [ "$HAS_ERROR" = "true" ]; then
            exit 1
          fi

      - name: Validate NVIDIA_API_KEY with nvcr.io
        id: validate-nvidia-key
        run: |
          echo "Validating NVIDIA_API_KEY with nvcr.io..."
          
          # Try to login to nvcr.io to validate the API key
          if echo "${{ secrets.NVIDIA_API_KEY }}" | docker login nvcr.io -u '$oauthtoken' --password-stdin 2>&1; then
            echo "SUCCESS: NVIDIA_API_KEY is valid for nvcr.io"
            echo "valid=true" >> $GITHUB_OUTPUT
            docker logout nvcr.io > /dev/null 2>&1 || true
          else
            echo "::error::NVIDIA_API_KEY is invalid or expired! Docker login to nvcr.io failed."
            echo "Please update your NVIDIA_API_KEY:"
            echo "  1. Go to https://build.nvidia.com to get a new API key"
            echo "  2. Update the secret in Settings > Secrets and variables > Actions"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

  deploy:
    needs: preflight
    if: needs.preflight.outputs.nvidia-api-key-valid == 'true'
    runs-on: arc-runners-org-nvidia-ai-bp-4-gpu
    # runs-on: arc-runner-set-oke-org-poc-4-gpu
    env:
      NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update and initialize submodules
        run: git submodule update --init --recursive

      - name: Build Docker image
        env:
          MODEL_DIRECTORY: nim-cache
        run: |
          docker build -t ctx_rag -f external/context-aware-rag/docker/Dockerfile external/context-aware-rag

      - name: Build Docker images
        run: |
          docker compose -f deploy/docker-compose.yaml --profile replay build

      - name: Clean up orphaned containers
        run: |
          echo "Cleaning up orphaned containers and networks..."
          
          docker compose -f external/context-aware-rag/docker/deploy/compose.yaml down --remove-orphans || true
          docker compose -f deploy/docker-compose.yaml --profile replay down --remove-orphans || true
          
          docker system prune -f
          
          echo "Checking system resources..."
          free -h
          df -h
          docker system df
          
          echo "Cleanup completed successfully!"

      - name: Start services
        run: |
          echo "${{ secrets.NVIDIA_API_KEY }}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
           
          docker pull nvcr.io/nim/nvidia/llama-3.2-nv-embedqa-1b-v2:1.10.0

          docker compose -f external/context-aware-rag/docker/deploy/compose.yaml up -d \
            --scale jaeger=0 \
            --scale cassandra=0 \
            --scale cassandra-schema=0 \
            --scale otel_collector=0 \
            --scale prometheus=0 \
            --scale grafana=0
          
          echo "Waiting for RAG services to be healthy..."

      - name: Wait for RAG services to be healthy
        run: |
          echo "Checking RAG services health..."
          
          # Wait for Retrieval service
          echo "Waiting for Retrieval service..."
          timeout 300 bash -c 'until curl -f http://localhost:8000/health; do sleep 5; done'
          
          # Wait for Ingestion service
          echo "Waiting for Ingestion service..."
          timeout 300 bash -c 'until curl -f http://localhost:8001/health; do sleep 5; done'
          
          # Wait for Milvus
          echo "Waiting for Milvus..."
          timeout 300 bash -c 'until curl -f http://localhost:9091/healthz; do sleep 5; done'
          
          # Wait for Neo4j
          echo "Waiting for Neo4j..."
          timeout 300 bash -c 'until curl -f http://localhost:7474; do sleep 5; done'
          
          echo "All RAG services are healthy!"

      - name: Deploy FM Radio Ingestion Workflow and UI
        run: |
          echo "Deploying FM Radio Ingestion Workflow and UI..."
          docker compose -f deploy/docker-compose.yaml --profile replay up -d
          echo "FM Radio Ingestion Workflow and UI deployed successfully!"

  scan:
    needs: preflight
    if: always()
    uses: NVIDIA-AI-Blueprints/nim-docker-scanner/.github/workflows/scan.yml@main
    with:
      # exclude-dirs: 'external'
      resolve-latest: true
      scan-docker-images: true
      scan-hosted-nim: ${{ needs.preflight.outputs.nvcf-config-token-exists == 'true' }}
    secrets:
      NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
      NVCF_CONFIG_ON_GITHUB_TOKEN: ${{ secrets.NVCF_CONFIG_ON_GITHUB_TOKEN }}
