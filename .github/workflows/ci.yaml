# =============================================================================
# Streaming Data to RAG CI
# =============================================================================
#
# Required Secrets:
#   - NGC_API_KEY          : NVIDIA NGC API Key for container registry access
#   - NVIDIA_API_KEY       : NVIDIA API Key for hosted NIM services
#   - SMTP_USERNAME        : Gmail address for sending notification emails
#   - SMTP_PASSWORD        : Gmail app-specific password for SMTP
#
# pytest markers:
#   - sdr and (notebook or ui)
#
# =============================================================================

name: Streaming Data to RAG CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  TEST_IMAGE: nvcr.io/rw983xdqtcdp/auto_test_team/blueprint-github-test-image:latest
  QA_TESTER_REPO: https://github.com/bp-cicd-org/qa-tester.git

jobs:
  # ============================================
  # PREFLIGHT: Check all prerequisites
  # ============================================
  preflight:
    name: Preflight Checks
    runs-on: ubuntu-latest
    outputs:
      preflight_passed: ${{ steps.preflight.outputs.passed }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Docker Login to NGC
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "✓ NGC Docker login successful"

      - name: Preflight Checks
        id: preflight
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        run: |
          echo "========================================"
          echo "  PREFLIGHT CHECKS"
          echo "========================================"
          echo ""
          
          FAILED=0
          
          # Check 1: NGC API Key
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 1/6] NGC API Key                      │"
          echo "└──────────────────────────────────────────────┘"
          if [ -z "${NGC_API_KEY}" ]; then
            echo "✗ ERROR: NGC_API_KEY is not set"
            FAILED=1
          else
            echo "✓ NGC_API_KEY is set"
          fi
          echo ""
          
          # Check 2: NVIDIA API Key
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 2/6] NVIDIA API Key                   │"
          echo "└──────────────────────────────────────────────┘"
          if [ -z "${NVIDIA_API_KEY}" ]; then
            echo "✗ ERROR: NVIDIA_API_KEY is not set"
            FAILED=1
          else
            echo "✓ NVIDIA_API_KEY is set"
          fi
          echo ""
          
          # Check 3: Test Image can be pulled
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 3/6] Test Image                       │"
          echo "└──────────────────────────────────────────────┘"
          echo "Pulling test image: ${{ env.TEST_IMAGE }}"
          if docker pull ${{ env.TEST_IMAGE }}; then
            echo "✓ Test image pulled successfully"
          else
            echo "✗ ERROR: Cannot pull test image"
            FAILED=1
          fi
          echo ""
          
          # Check 4: Required notebook exists
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 4/6] Required Notebook                │"
          echo "└──────────────────────────────────────────────┘"
          if [ -f "notebooks/quickstart.ipynb" ]; then
            echo "✓ notebooks/quickstart.ipynb exists"
          else
            echo "✗ ERROR: notebooks/quickstart.ipynb not found"
            FAILED=1
          fi
          echo ""
          
          # Check 5: Submodules
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 5/6] Git Submodules                   │"
          echo "└──────────────────────────────────────────────┘"
          if [ -d "external/context-aware-rag" ] && [ "$(ls -A external/context-aware-rag 2>/dev/null)" ]; then
            echo "✓ context-aware-rag submodule is initialized"
          else
            echo "⚠ WARNING: context-aware-rag submodule may not be initialized"
          fi
          if [ -d "external/NeMo-Agent-Toolkit-UI" ] && [ "$(ls -A external/NeMo-Agent-Toolkit-UI 2>/dev/null)" ]; then
            echo "✓ NeMo-Agent-Toolkit-UI submodule is initialized"
          else
            echo "⚠ WARNING: NeMo-Agent-Toolkit-UI submodule may not be initialized"
          fi
          echo ""
          
          # Check 6: Clone qa-tester repository
          echo "┌──────────────────────────────────────────────┐"
          echo "│ [Check 6/6] QA Tester Repository             │"
          echo "└──────────────────────────────────────────────┘"
          echo "Cloning qa-tester repository..."
          if git clone --depth 1 https://x-access-token:${{ github.token }}@github.com/bp-cicd-org/qa-tester.git _qa_tester; then
            if [ -f "_qa_tester/utils/notebook_runner/notebook_runner_nbclient.py" ]; then
              echo "✓ qa-tester cloned and notebook_runner_nbclient.py found"
            else
              echo "✗ ERROR: notebook_runner_nbclient.py not found in qa-tester"
              FAILED=1
            fi
          else
            echo "✗ ERROR: Cannot clone qa-tester repository"
            FAILED=1
          fi
          echo ""
          
          # Final result
          echo "========================================"
          if [ $FAILED -eq 0 ]; then
            echo "✓ ALL PREFLIGHT CHECKS PASSED"
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "✗ PREFLIGHT CHECKS FAILED"
            echo "passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "========================================"

  # ============================================
  # SDR: Notebook Deploy + Test
  # ============================================
  streaming-data-to-rag:
    name: Streaming Data to RAG - Deploy & Test
    needs: preflight
    if: ${{ needs.preflight.outputs.preflight_passed == 'true' }}
    runs-on: arc-runner-set-oke-org-poc-4-gpu
    # runs-on: arc-runners-org-nvidia-ai-bp-4-gpu
    timeout-minutes: 240
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      # ==========================================
      # PHASE 1: Environment Setup
      # ==========================================
      - name: Setup Environment
        run: |
          echo "========================================"
          echo "  STREAMING DATA TO RAG - ENVIRONMENT SETUP"
          echo "========================================"
          
          # System info
          echo "Runner: $(hostname)"
          echo "OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d'"' -f2)"
          echo "Docker: $(docker --version)"
          echo ""
          
          # GPU info
          echo "GPU Information:"
          nvidia-smi --query-gpu=index,name,memory.total --format=csv,noheader || echo "nvidia-smi not available"
          echo ""

      - name: Docker Login to NGC
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          echo "${NGC_API_KEY}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          echo "✓ NGC Docker login successful"

      - name: Pull Test Image
        run: |
          echo "Pulling test image: ${{ env.TEST_IMAGE }}"
          docker pull ${{ env.TEST_IMAGE }}
          echo "✓ Test image pulled successfully"

      # ==========================================
      # PHASE 2: Setup Notebook Runner
      # ==========================================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download Notebook Runner
        run: |
          echo "Cloning qa-tester repository..."
          git clone --depth 1 https://x-access-token:${{ github.token }}@github.com/bp-cicd-org/qa-tester.git _qa_tester
          cp _qa_tester/utils/notebook_runner/notebook_runner_nbclient.py .
          rm -rf _qa_tester
          chmod +x notebook_runner_nbclient.py
          echo "✓ notebook_runner_nbclient.py ready"

      - name: Install Notebook Dependencies
        run: |
          pip install --upgrade pip
          pip install ipykernel nbclient nbformat jupyter nbconvert
          python -m ipykernel install --user --name python3 --display-name "Python 3"
          echo "✓ Notebook dependencies installed"

      # ==========================================
      # PHASE 3: Pre-configure Environment
      # ==========================================
      - name: Pre-configure Environment Variables
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
        run: |
          # Set environment variables for SDR deployment
          echo "NVIDIA_API_KEY=${NVIDIA_API_KEY}" >> $GITHUB_ENV
          echo "NGC_API_KEY=${NGC_API_KEY}" >> $GITHUB_ENV
          
          # Model directory for NIM cache
          MODEL_DIRECTORY=$(pwd)/models
          echo "MODEL_DIRECTORY=${MODEL_DIRECTORY}" >> $GITHUB_ENV
          mkdir -p ${MODEL_DIRECTORY}
          chmod 777 -R ${MODEL_DIRECTORY}
          
          # Replay configuration
          echo "REPLAY_FILES=sample_files/ai_gtc_1.mp3,sample_files/ai_gtc_2.mp3,sample_files/ai_gtc_3.mp3" >> $GITHUB_ENV
          echo "REPLAY_TIME=3600" >> $GITHUB_ENV
          echo "REPLAY_MAX_FILE_SIZE=50" >> $GITHUB_ENV
          echo "RAG_UUID=123456" >> $GITHUB_ENV
          
          echo "✓ Environment variables configured"

      # ==========================================
      # PHASE 4: Execute Notebook (Deploy)
      # ==========================================
      - name: Execute Notebook - Deploy Streaming Data to RAG
        env:
          NGC_API_KEY: ${{ secrets.NGC_API_KEY }}
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
        run: |
          echo "========================================"
          echo "  EXECUTING NOTEBOOK: quickstart"
          echo "========================================"
          
          COMMIT_SHA=$(git rev-parse --short=7 HEAD)
          
          cd notebooks
          
          python ../notebook_runner_nbclient.py \
            -f quickstart.ipynb \
            --output-dir ../notebook_output \
            --timeout 3600 \
            --skip-deps-check \
            --skip-tags ci-skip \
            -e NGC_API_KEY="${NGC_API_KEY}" \
            -e NVIDIA_API_KEY="${NVIDIA_API_KEY}"
          
          echo ""
          echo "✓ Notebook execution completed"
          echo "Generated files:"
          ls -la ../notebook_output/

      - name: Wait for Services Ready
        run: |
          echo "========================================"
          echo "  WAITING FOR SERVICES TO BE READY"
          echo "========================================"
          
          MAX_ATTEMPTS=150
          ATTEMPT=0
          
          # Wait for UI (port 3000)
          echo "Checking UI service (http://localhost:3000)..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if curl -sf -o /dev/null http://localhost:3000 2>/dev/null; then
              echo "✓ UI is ready (attempt $ATTEMPT)"
              break
            fi
            [ $((ATTEMPT % 10)) -eq 0 ] && echo "  Waiting... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          # Wait for Retrieval service (port 8000)
          ATTEMPT=0
          echo "Checking Retrieval service (http://localhost:8000/health)..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if curl -sf -o /dev/null http://localhost:8000/health 2>/dev/null; then
              echo "✓ Retrieval service is ready (attempt $ATTEMPT)"
              break
            fi
            [ $((ATTEMPT % 10)) -eq 0 ] && echo "  Waiting... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          # Wait for Ingestion service (port 8001)
          ATTEMPT=0
          echo "Checking Ingestion service (http://localhost:8001/health)..."
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            if curl -sf -o /dev/null http://localhost:8001/health 2>/dev/null; then
              echo "✓ Ingestion service is ready (attempt $ATTEMPT)"
              break
            fi
            [ $((ATTEMPT % 10)) -eq 0 ] && echo "  Waiting... ($ATTEMPT/$MAX_ATTEMPTS)"
            sleep 2
          done
          
          if [ $ATTEMPT -ge $MAX_ATTEMPTS ]; then
            echo "⚠ WARNING: Some services timeout, but continuing..."
          fi
          
          # Show container status
          echo ""
          echo "Docker containers status:"
          docker ps -a --format "table {{.Names}}\t{{.Status}}"

      # ==========================================
      # PHASE 5: Run pytest Tests
      # ==========================================
      - name: Run Tests - Notebook and UI
        id: pytest
        continue-on-error: true
        run: |
          echo "========================================"
          echo "  RUNNING PYTEST: sdr (notebook + ui)"
          echo "========================================"
          
          COMMIT_SHA=$(git rev-parse --short=7 HEAD)
          REPORT_FILE="sdr_${COMMIT_SHA}_test_report.html"
          
          # Service URLs
          UI_URL="http://localhost:3000"
          
          echo "UI URL: $UI_URL"
          echo ""
          
          mkdir -p test_reports
          
          # Copy notebook HTML output for notebook tests
          # The notebook test expects: srd-launchable.html
          NOTEBOOK_HTML=$(ls notebook_output/*.html 2>/dev/null | head -1)
          if [ -n "$NOTEBOOK_HTML" ]; then
            cp "$NOTEBOOK_HTML" notebook_output/srd-launchable.html
            echo "✓ Notebook HTML prepared: $NOTEBOOK_HTML -> srd-launchable.html"
          fi
          
          # Run pytest with test image
          docker run --rm \
            --network host \
            -v "$(pwd)/notebook_output:/app/input" \
            -v "$(pwd)/test_reports:/app/reports" \
            ${{ env.TEST_IMAGE }} \
            pytest -m "sdr and (notebook or ui)" \
              --sdr-playground-url="$UI_URL" \
              --disable-warnings \
              --self-contained-html \
              --html=/app/reports/${REPORT_FILE} \
            || echo "pytest_exit_code=$?" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Test report saved to: test_reports/${REPORT_FILE}"

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sdr-test-report
          path: test_reports/
          retention-days: 30

      - name: Upload Notebook HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: sdr-notebook-html
          path: notebook_output/*.html
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          echo "Stopping all containers..."
          docker compose -f deploy/docker-compose.yaml --profile replay down 2>/dev/null || true
          docker compose -f external/context-aware-rag/docker/deploy/compose.yaml down 2>/dev/null || true
          docker stop $(docker ps -aq) 2>/dev/null || true
          echo "✓ Cleanup completed"

  # ============================================
  # SUMMARY: Generate final report
  # ============================================
  summary:
    name: Generate Summary
    needs: [preflight, streaming-data-to-rag]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Generate Summary Report
        run: |
          echo "# Streaming Data to RAG CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Generated at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Job Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Preflight | ${{ needs.preflight.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Streaming Data to RAG | ${{ needs.streaming-data-to-rag.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Test Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Notebook**: \`notebooks/quickstart.ipynb\`" >> $GITHUB_STEP_SUMMARY
          echo "- **pytest markers**: \`sdr and (notebook or ui)\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Test reports and notebook HTML outputs are available in the Artifacts section." >> $GITHUB_STEP_SUMMARY
          
          if [ -d "artifacts" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Downloaded Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find artifacts -type f -name "*.html" 2>/dev/null || echo "No HTML files found"
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Set Result Output
        id: set_result
        if: always()
        run: |
          if [ "${{ needs.preflight.result }}" == "success" ] && [ "${{ needs.streaming-data-to-rag.result }}" == "success" ]; then
            echo "RESULT=PASS" >> $GITHUB_OUTPUT
          else
            echo "RESULT=FAIL" >> $GITHUB_OUTPUT
          fi

      - name: Send Email Notification
        uses: dawidd6/action-send-mail@6e71c855c9a091d80a519621b9fd3e8d252ca40c
        if: always()
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "CI Result: Streaming Data to RAG - ${{ steps.set_result.outputs.RESULT }}"
          to: Github-Action-Blueprint-QA@nvidia.com
          from: github-workflow-notification@gmail.com
          html_body: |
            <h2>Streaming Data to RAG CI Notification</h2>
            
            <p><strong>Repository:</strong> ${{ github.repository }}</p>
            <p><strong>Branch:</strong> ${{ github.ref_name }}</p>
            <p><strong>Commit:</strong> ${{ github.sha }}</p>
            <p><strong>Result:</strong> <span style="color: ${{ steps.set_result.outputs.RESULT == 'PASS' && 'green' || 'red' }}; font-weight: bold;">${{ steps.set_result.outputs.RESULT }}</span></p>
            
            <h3>Job Results</h3>
            <table border="1" cellpadding="5" cellspacing="0">
              <tr><th>Job</th><th>Status</th></tr>
              <tr><td>Preflight</td><td>${{ needs.preflight.result }}</td></tr>
              <tr><td>Streaming Data to RAG</td><td>${{ needs.streaming-data-to-rag.result }}</td></tr>
            </table>
            
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Workflow Run</a></p>
